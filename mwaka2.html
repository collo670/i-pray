<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>kawaida</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body{
        background-color: #1f2937;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
      display: block;
      margin: 0 auto;
    }
    h1{
        color: white;
        font-size: xx-large;
    }
  </style>
</head>
<body data-src="PDFS/MwakaSehemu2.pdf">
    <nav class="fixed top-0 left-0 right-0 bg-[#202847] shadow z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="text-lg font-semibold text-white">KIPINDI CHA KAWAIDA 11-20</div>
            <div class="space-x-4">
                <a href="index.html" class="text-gray-300 hover:text-white">Home</a>
                <a href="#" class="text-gray-300 hover:text-white"></a>
                <a href="#" class="text-gray-300 hover:text-white"></a>
            </div>
        </div>
    </nav>

    <br><br><br>
    <div class="mb-4 text-center">
        <div class="inline-flex flex-wrap justify-center gap-2">
            <button id="prevPage" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Previous</button>
            <button id="nextPage" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Next</button>
            <button id="zoomIn" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Zoom In</button>
            <button id="zoomOut" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">Zoom Out</button>
        </div>
    </div>

    <div class="text-center text-yellow-200 text-sm mb-2">
        ikiwa maneno hayaonekani vizuri, bofya zoom in/zoom out au <span class="italic">refresh</span> ukurasa ili kupata usomaji mzuri
    </div>
    <canvas id="pdfCanvas" class="border rounded shadow w-full max-w-4xl"></canvas>

    <div class="text-sm mt-2 text-center">
        Page <span id="pageNum">1</span> of <span id="pageCount">--</span>
    </div>

    <script>
        const url = document.body.getAttribute('data-src');

        let pdfDoc = null;
        let pageNum = 1;
        let currentScale = 2.5;

        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');

        function renderPage(num) {
            pdfDoc.getPage(num).then((page) => {
                // Calculate scale to fit screen width
                const containerWidth = Math.min(window.innerWidth, 1024); // 1024px max for large screens
                const unscaledViewport = page.getViewport({ scale: 1 });
                let fitScale = containerWidth / unscaledViewport.width;
                // Use the larger of fitScale or currentScale (for desktop zoom), but on mobile, fit to width
                let scale = window.innerWidth < 640 ? fitScale : currentScale;
                const viewport = page.getViewport({ scale });
                const dpr = window.devicePixelRatio || 1;
                canvas.width = viewport.width * dpr;
                canvas.height = viewport.height * dpr;
                canvas.style.width = viewport.width + 'px';
                canvas.style.height = viewport.height + 'px';
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

                page.render({ canvasContext: ctx, viewport });
                document.getElementById('pageNum').textContent = num;

                // Save last viewed page
                localStorage.setItem(`lastPage_${url}`, num);
            });
        }

        document.getElementById('prevPage').addEventListener('click', () => {
            if (pageNum <= 1) return;
            pageNum--;
            renderPage(pageNum);
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            if (pageNum >= pdfDoc.numPages) return;
            pageNum++;
            renderPage(pageNum);
        });

        document.getElementById('zoomIn').addEventListener('click', () => {
            currentScale *= 1.2;
            renderPage(pageNum);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            currentScale /= 1.2;
            renderPage(pageNum);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') document.getElementById('nextPage').click();
            if (e.key === 'ArrowLeft') document.getElementById('prevPage').click();
        });

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const displayWidth = canvas.offsetWidth;
            if (clickX < displayWidth / 2 && pageNum > 1) {
                pageNum--;
                renderPage(pageNum);
            } else if (clickX >= displayWidth / 2 && pageNum < pdfDoc.numPages) {
                pageNum++;
                renderPage(pageNum);
            }
        });

        // BUG FIX: Wait for DOMContentLoaded and handle errors
        document.addEventListener('DOMContentLoaded', function () {
            if (!window['pdfjsLib']) {
                alert('PDF.js library failed to load.');
                return;
            }
            window['pdfjsLib'].getDocument(url).promise.then((pdf) => {
                pdfDoc = pdf;
                document.getElementById('pageCount').textContent = pdf.numPages;

                // Restore last page if available
                const savedPage = parseInt(localStorage.getItem(`lastPage_${url}`), 10);
                pageNum = savedPage && savedPage >= 1 && savedPage <= pdf.numPages ? savedPage : 1;
                renderPage(pageNum);
            }).catch(function (error) {
                alert('Failed to load PDF: ' + error.message);
            });
        });
    </script>
</body>
</html>